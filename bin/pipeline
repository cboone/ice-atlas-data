#!/usr/bin/env bash

# shellcheck disable=SC2155
declare -r command_name=$(basename "$0")

set -e

function main {
  local bounds_arg="--no-bounds"

  local deploy
  local download_region
  local update_regions="update regions"

  while (($# > 0)); do
    case "$1" in
    --deploy)
      deploy="deploy to production"
      shift
      ;;
    --download)
      download_region="download regions"
      update_regions=
      shift
      ;;
    --no-update)
      update_regions=
      shift
      ;;
    --use-existing-bounds)
      bounds_arg="--use-existing-bounds"
      shift
      ;;
    *)
      echo "[$command_name] Unexpected option \"$1\" ignored"
      shift
      ;;
    esac
  done

  echo
  if [ "$download_region" ]; then
    echo "[$command_name] Downloading foreground regions (New Hampshire, Vermont)"
    bin/download-region \
      --force \
      "$bounds_arg" \
      new_hampshire vermont

    echo "[$command_name] Downloading secondary regions (Maine, New York)"
    bin/download-region \
      --force \
      "$bounds_arg" \
      maine new_york
  else
    echo "[$command_name] Skipping downloads of foreground and secondary regions"
  fi

  echo
  if [ "$update_regions" ]; then
    echo "[$command_name] Updating foreground regions (New Hampshire, Vermont)"
    bin/update-region new_hampshire vermont

    echo "[$command_name] Updating secondary regions (Maine, New York)"
    bin/update-region maine new_york
  else
    echo "[$command_name] Skipping updates of foreground and secondary regions"
  fi

  echo
  echo "[$command_name] Extracting borders from each region (Vermont, New Hampshire, Maine, New York)"
  bin/extract-border \
    maine Maine \
    new_hampshire "New Hampshire" \
    new_york "New York" \
    vermont Vermont

  echo
  echo "[$command_name] Calculating bounding boxes of each region (Maine, New Hampshire, New York, Vermont)"
  bin/extract-bounds maine new_hampshire new_york vermont
  bin/calculate-bounds maine new_hampshire new_york vermont

  echo
  echo "[$command_name] Merging borders of foreground regions (New Hampshire, Vermont)"
  bin/merge-borders \
    nh new_hampshire \
    vt vermont

  echo
  echo "[$command_name] Merging borders of secondary region (Maine, New Hampshire, New York, Vermont)"
  bin/calculate-buffered-border --buffer -0.75 new_york
  bin/merge-borders \
    me maine \
    nh new_hampshire \
    nybuffered new_york-buffered \
    vt vermont

  echo
  echo "[$command_name] Extracting bounding box of foreground and secondary regions (nh-vt, me-nh-nybuffered-vt)"
  bin/extract-bounds nh-vt me-nh-nybuffered-vt
  bin/calculate-bounds nh-vt me-nh-nybuffered-vt

  echo
  if [ "$download_region" ]; then
    echo "[$command_name] Downloading background regions (Connecticut, Massachusetts, New Brunswick, Ontario, Québec, Rhode Island)"
    bin/download-region \
      --force \
      --bounds "$(cat bounding-boxes/me-nh-nybuffered-vt.csv)" \
      connecticut massachusetts new_brunswick ontario quebec rhode_island
  else
    echo "[$command_name] Skipping downloads of background regions"
  fi

  echo
  if [ "$update_regions" ]; then
    echo "[$command_name] Updating background regions (Connecticut, Massachusetts, New Brunswick, Ontario, Québec, Rhode Island))"
    bin/update-region connecticut massachusetts new_brunswick ontario quebec rhode_island
  else
    echo "[$command_name] Skipping updates of background regions"
  fi

  echo
  echo "[$command_name] Merging foreground regions (New Hampshire, Vermont)"
  bin/merge-regions nh-vt new_hampshire vermont

  echo
  echo "[$command_name] Merging background regions (Connecticut, Massachusetts, New Brunswick, New York, Ontario, Québec, Rhode Island)"
  bin/merge-regions \
    ct-ma-nb-ny-on-qc-ri \
    connecticut massachusetts new_brunswick new_york ontario quebec rhode_island

  echo
  echo "[$command_name] Converting foreground region into PMTiles archive (nh-vt)"
  bin/convert-region-to-pmtiles nh-vt

  echo
  echo "[$command_name] Converting background region into PMTiles archive (ct-ma-nb-ny-on-qc-ri)"
  bin/convert-region-to-pmtiles \
    --bounds me-nh-nybuffered-vt \
    ct-ma-nb-ny-on-qc-ri

  echo
  echo "[$command_name] Generating scrim PMTiles archive (me-nh-nybuffered-vt-minus-nh-vt)"
  bin/generate-scrim me-nh-nybuffered-vt nh-vt

  echo
  echo "[$command_name] Copying tile archives to development repo (background, scrim, foreground)"
  bin/copy-to-development ct-ma-nb-ny-on-qc-ri background
  bin/copy-to-development me-nh-nybuffered-vt-minus-nh-vt scrim
  bin/copy-to-development nh-vt foreground

  if [ "$deploy" ]; then
    echo
    echo "[$command_name] Deploying files to development repo (background, scrim, foreground)"
    bin/deploy ct-ma-nb-ny-on-qc-ri background
    bin/deploy me-nh-nybuffered-vt-minus-nh-vt scrim
    bin/deploy nh-vt foreground
  fi
}

echo "[$command_name] Started at $(date -u '+%Y-%m-%d %H:%M:%S')"
main "$@"
echo
echo "[$command_name] Finished at $(date -u '+%Y-%m-%d %H:%M:%S')"
