#!/usr/bin/env bash

function main {
  set -e

  local -r start_time="$(date -u '+%Y-%m-%d %H:%M:%S')"
  echo "[pipeline] Started at $start_time"

  local download_region
  local update_regions="update regions"
  while (($# > 0)); do
    case "$1" in
    --download)
      download_region="download regions"
      update_regions=
      shift
      ;;
    --no-update)
      update_regions=
      shift
      ;;
    *)
      echo "[pipeline] Unexpected option \"$1\" ignored"
      shift
      ;;
    esac
  done

  echo
  if [ "$download_region" ]; then
    echo "[pipeline] Downloading foreground regions (Vermont, New Hampshire)"
    bin/download-regions --force vermont new_hampshire
  else
    echo "[pipeline] Skipping initial downloads"
  fi

  echo
  if [ "$update_regions" ]; then
    echo "[pipeline] Updating foreground regions (Vermont, New Hampshire)"
    bin/update-region vermont new_hampshire
  else
    echo "[pipeline] Skipping initial updates"
  fi

  echo
  echo "[pipeline] Extracting borders from foreground regions (Vermont, New Hampshire)"
  bin/extract-border vermont new_hampshire

  echo
  echo "[pipeline] Merging borders from foreground regions (Vermont, New Hampshire)"
  bin/merge-borders vt vermont Vermont nh new_hampshire "New Hampshire"

  echo
  echo "[pipeline] Extracting bounding box from merged foreground region (vt-nh)"
  bin/extract-bounds vt-nh

  echo
  echo "[pipeline] Merging foreground regions (Vermont, New Hampshire)"
  bin/merge-regions vt-nh vermont new_hampshire

  echo
  echo "[pipeline] Extracting foreground region using merged borders (vt-nh)"
  bin/extract-region vt-nh

  echo
  echo "[pipeline] Converting foreground region into pmtiles archive (vt-nh)"
  bin/convert-region-to-pmtiles vt-nh

  echo
  echo "[pipeline] Copying foreground region to development repo (vt-nh)"
  bin/copy-to-development vt-nh foreground
}

main "$@"
