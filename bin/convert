#!/usr/bin/env bash

function main {
  set -e

  local -r start_time="$(date -u '+%Y-%m-%d %H:%M:%S')"
  echo "[convert] Started at $start_time"

  local -r dir="$(pwd)"

  local bounding_box="-77.4448803163,42.0041639122,-66.6042989998,47.5416852124" # whole shebang

  local file

  while (($# > 0)); do
    case "$1" in
    vt-nh)
      file="vt-nh"
      bounding_box="-73.4377402067,42.6972286785,-70.5613593757,45.3057790187" # vt-nh
      shift
      ;;
    *)
      file="$1"
      shift
      ;;
    esac
  done

  echo "[convert] Converting planetiler/$file.osm.pbf into tiles/$file.pmtiles"

  set -x
  docker run \
    --rm \
    -e JAVA_TOOL_OPTIONS="-Xmx32g -XX:MaxHeapFreeRatio=40" \
    -v "$dir/planetiler":/data \
    -v "$dir/tiles":/output \
    ghcr.io/onthegomap/planetiler:latest \
    --osm_path="/data/$file.osm.pbf" \
    --output="/output/$file.pmtiles" \
    --bounds="$bounding_box" \
    --nodemap-type=sparsearray \
    --storage=ram \
    --transportation_name_size_for_shield \
    --transportation_name_limit_merge \
    --boundary-osm-only \
    --building_merge_z13=false \
    --max-point-buffer=4 \
    --maxzoom=15 \
    --render_maxzoom=15 \
    --force
}

main "$@"
