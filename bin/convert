#!/usr/bin/env bash

set -e

declare -r start_time="$(date -u '+%Y-%m-%d %H:%M:%S')"
echo "[convert] Started at $start_time"

declare -r dir="$(pwd)"
declare -r file="$1"
shift 1

echo "[convert] Converting $file.osm.pbf into $file.pmtiles"

set -x
docker run \
  --rm \
  -e JAVA_TOOL_OPTIONS="-Xmx32g -XX:MaxHeapFreeRatio=40" \
  -v "$dir/data":/data \
  ghcr.io/onthegomap/planetiler:latest \
  --osm_path="/data/$file.osm.pbf" \
  --output="/data/$file.pmtiles" \
  --bounds="-77.4448803163,42.0041639122,-66.6042989998,47.5416852124" \
  --nodemap-type=sparsearray \
  --storage=ram \
  --transportation_name_size_for_shield \
  --transportation_name_limit_merge \
  --boundary-osm-only \
  --building_merge_z13=false \
  --max-point-buffer=4 \
  --maxzoom=15 \
  --render_maxzoom=15 \
  --force
