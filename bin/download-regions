#!/usr/bin/env bash

set -e

function main {
  local -r start_time="$(date -u '+%Y-%m-%d %H:%M:%S')"
  echo "[download] Started at $start_time"

  local -r dir="$(pwd)"
  # local bounding_box="-77.4448803163,42.0041639122,-66.6042989998,47.5416852124" # whole shebang
  local -a regions=()
  local remove_first=false

  while (($# > 0)); do
    case "$1" in
    --force)
      remove_first=true
      shift
      ;;
    others)
      regions=(massachusetts new_york ontario quebec new_brunswick maine)
      shift
      ;;
    vt-nh)
      regions=(vermont new_hampshire)
      # bounding_box="-73.4377402067,42.6972286785,-70.5613593757,45.3057790187" # vt-nh
      shift
      ;;
    *)
      regions+=("$1")
      shift
      ;;
    esac
  done

  for region in "${regions[@]}"; do
    local destination="$dir/pbf/sources/$region.osm.pbf"

    echo
    echo "[download] Downloading $region from geofabrik to $destination"

    if [[ $remove_first ]]; then
      echo "[download] Removing old $destination first"
      rm -rf "$destination"
    fi

    # --bounds="$bounding_box" \
    docker run \
      --rm \
      -e JAVA_TOOL_OPTIONS="-Xmx32g -XX:MaxHeapFreeRatio=40" \
      -v "$dir/pbf":/data \
      ghcr.io/onthegomap/planetiler:latest \
      --area="$region" \
      --download \
      --only-download \
      --download-threads=10 \
      --download-chunk-size-mb=1000 \
      --fetch-wikidata \
      --nodemap-type=sparsearray \
      --storage=ram \
      --transportation_name_size_for_shield \
      --transportation_name_limit_merge \
      --boundary-osm-only \
      --max-point-buffer=4 \
      --building_merge_z13=false \
      --maxzoom=15 \
      --render_maxzoom=15
  done
}

main "$@"
